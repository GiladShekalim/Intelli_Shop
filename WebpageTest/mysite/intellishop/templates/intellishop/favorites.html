{% extends 'intellishop/index_home_original.html' %}

{% block content %}
    <section class="py-5">
        <div class="container">
            <div class="row gx-5 align-items-center">
                <div class="col-12">
                    <!-- User Details Section (existing) -->
                    <div class="user-welcome p-4 bg-light rounded shadow-sm mb-4" style="border-left: 4px solid #28a745;">
                        <h2>My Favorites!<span class="text-danger ms-3">❤️</span></h2>
                        <p><strong>Email:</strong> {{ user.email }}</p>
                        <p><strong>Total Favorites:</strong> {{ favorite_count }}</p>
                        
                        <!-- Status and Interests sections (existing) -->
                        <!-- ... existing code ... -->
                    </div>
                    
                    <hr class="mb-4">

                    <!-- Favorites List -->
                    {% if favorite_coupons %}
                        <div class="favorites-container">
                            {% for coupon in favorite_coupons %}
                                <div class="discount-card favorite-item" data-discount-id="{{ coupon.discount_id }}">
                                    <div class="discount-flex-row">
                                        <div class="discount-image-col">
                                            <img src="{{ coupon.image_link }}" alt="{{ coupon.title }}" style="max-width:400px; max-height:400px; border-radius:8px;">
                                        </div>
                                        <div class="discount-details-col">
                                            <h4 class="discount-title">{{ coupon.title }}</h4>
                                            <div class="desc-block">
                                                <strong>תיאור:</strong>
                                                <div>{{ coupon.description|truncatechars:250 }}</div>
                                            </div>
                                            <div class="terms-block" style="margin-top:10px;">
                                                <strong>תנאים והגבלות:</strong>
                                                <div>{{ coupon.terms_and_conditions|truncatechars:250 }}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="discount-bottom-row">
                                        <div class="price-type-col">
                                            <span class="price-label-big" style="background:{% if coupon.discount_type == 'percentage' %}#28a745{% else %}#007bff{% endif %};color:white;padding:3px 9px;border-radius:16px;font-size:1em;font-weight:bold;display:inline-block;vertical-align:middle;">
                                                {% if coupon.discount_type == 'percentage' %}% הנחה{% else %}מחיר סופי{% endif %}
                                            </span>
                                            <span class="price-value-big">{{ coupon.price }}</span>
                                        </div>
                                        {% if coupon.coupon_code %}
                                            <div class="copy-code-btn" data-code="{{ coupon.coupon_code }}">
                                                Copy Code Coupon
                                            </div>
                                        {% endif %}
                                        {% if coupon.provider_link %}
                                            <a href="{{ coupon.provider_link }}" target="_blank" class="site-link-btn provider-link-btn">
                                                Go To Provider
                                            </a>
                                        {% endif %}
                                        <a href="{{ coupon.discount_link }}" target="_blank" class="site-link-btn">
                                            Discount Link
                                        </a>
                                        <div class="like-icon-col">
                                            <span class="like-fav-text">Favorites <span class="like-icon favorite-active" title="Click To Remove" data-discount-id="{{ coupon.discount_id }}">&#10084;</span> Remove</span>
                                        </div>
                                    </div>
                                    <hr>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="no-favorites-message text-center py-5">
                            <i class="bi bi-heart" style="font-size: 4rem; color: #ccc;"></i>
                            <h3 class="mt-3">No Favorites Yet</h3>
                            <p class="text-muted">Start adding coupons to your favorites by clicking the heart icon on any discount!</p>
                            <a href="{% url 'filter_search' %}" class="btn btn-primary">Browse Discounts</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>

    <style>
        .favorite-active {
            color: #ff0000 !important;
        }
        .no-favorites-message {
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Handle favorite removal
            document.querySelectorAll('.like-icon.favorite-active').forEach(icon => {
                icon.addEventListener('click', function() {
                    const discountId = this.getAttribute('data-discount-id');
                    removeFavorite(discountId, this);
                });
            });

            // Handle copy coupon code
            document.querySelectorAll('.copy-code-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const code = this.getAttribute('data-code');
                    copyToClipboard(code, this);
                });
            });
        });

        function removeFavorite(discountId, iconElement) {
            fetch('/remove_favorite/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({discount_id: discountId})
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Remove the entire card from the page
                    const card = iconElement.closest('.favorite-item');
                    card.remove();
                    
                    // Update favorite count
                    const countElement = document.querySelector('.user-welcome p:nth-child(3)');
                    const currentCount = parseInt(countElement.textContent.match(/\d+/)[0]);
                    countElement.innerHTML = `<strong>Total Favorites:</strong> ${currentCount - 1}`;
                    
                    // Show empty state if no more favorites
                    if (currentCount - 1 === 0) {
                        location.reload(); // Reload to show empty state
                    }
                } else {
                    alert('Failed to remove from favorites: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to remove from favorites');
            });
        }

        function copyToClipboard(text, buttonElement) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = buttonElement.textContent;
                buttonElement.textContent = '! Copied';
                buttonElement.classList.add('copied');
                setTimeout(() => {
                    buttonElement.textContent = originalText;
                    buttonElement.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
{% endblock %}
